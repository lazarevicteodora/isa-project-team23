# ============================================================================
# REFAKTORISAN DOCKER COMPOSE - Podr≈æava proizvoljan broj replika!
# ============================================================================
# Ova konfiguracija ima 3 replike kao primer, ali mo≈æe≈° dodavati koliko god ≈æeli≈°.
# Da doda≈° novu repliku:
# 1. Kopiraj jedan od backend servisa (npr. backend1)
# 2. Promeni: container_name, REPLICA_ID, REPLICA_URLS, i port mapping
# 3. Dodaj novi server u nginx.conf
# ============================================================================

services:
  # PostgreSQL Database - JEDNA za sve replike
  postgres:
    image: postgres:15-alpine
    container_name: jutjubic-postgres
    environment:
      POSTGRES_DB: isa_project_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: root
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Inicijalizacioni SQL (opciono)
      # - ./migration.sql:/docker-entrypoint-initdb.d/01-migration.sql
    networks:
      - jutjubic-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d isa_project_db"]
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Backend Replica 1
  backend1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jutjubic-backend1
    environment:
      REPLICA_ID: replica-1
      SERVER_PORT: 8080

      # REPLIKA ZA CRDT SINHRONIZACIJU - Lista URL-ova OSTALIH replika
      # Dodaj nove replike ovde odvojene zarezom
      REPLICA_URLS: http://backend2:8080,http://backend3:8080
      CRDT_PUSH_ENABLED: "true"
      CRDT_PERIODIC_ENABLED: "true"

      #  Spoj se na HOST bazu (localhost iz perspektive tvog raƒçunara)
      DB_URL: jdbc:postgresql://host.docker.internal:5432/isa_project_db
      DB_USERNAME: postgres
      DB_PASSWORD: root

      SPRING_PROFILES_ACTIVE: production

      JAVA_OPTS: >
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
    ports:
      - "8081:8080"
    volumes:
      - ./storage:/app/storage
      - ./cache:/app/cache
    networks:
      - jutjubic-network
    restart: unless-stopped

  # Backend Replica 2
  backend2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jutjubic-backend2
    environment:
      REPLICA_ID: replica-2
      SERVER_PORT: 8080

      # REPLIKA ZA CRDT SINHRONIZACIJU
      REPLICA_URLS: http://backend1:8080,http://backend3:8080
      CRDT_PUSH_ENABLED: "true"
      CRDT_PERIODIC_ENABLED: "true"

      # ‚úÖ Ista baza kao replica 1!
      DB_URL: jdbc:postgresql://host.docker.internal:5432/isa_project_db
      DB_USERNAME: postgres
      DB_PASSWORD: root

      SPRING_PROFILES_ACTIVE: production

      JAVA_OPTS: >
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
    ports:
      - "8082:8080"
    volumes:
      - ./storage:/app/storage
      - ./cache:/app/cache
    networks:
      - jutjubic-network
    restart: unless-stopped

  # Backend Replica 3 - NOVA REPLIKA! üéâ
  backend3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jutjubic-backend3
    environment:
      # Replica identifikacija
      REPLICA_ID: replica-3
      SERVER_PORT: 8080

      # REPLIKA ZA CRDT SINHRONIZACIJU
      REPLICA_URLS: http://backend1:8080,http://backend2:8080
      CRDT_PUSH_ENABLED: "true"
      CRDT_PERIODIC_ENABLED: "true"

      # Database connection (ISTA kao ostale replike!)
      DB_URL: jdbc:postgresql://postgres:5432/isa_project_db
      DB_USERNAME: postgres
      DB_PASSWORD: root

      # Spring profiles
      SPRING_PROFILES_ACTIVE: production

      # JVM options
      JAVA_OPTS: >
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
    ports:
      - "8083:8080"  # Za direktan pristup (testing)
    volumes:
      - ./storage:/app/storage  # Shared storage za video fajlove
      - ./cache:/app/cache      # Shared cache
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - jutjubic-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: jutjubic-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - backend1
      - backend2
      - backend3
    networks:
      - jutjubic-network
    restart: unless-stopped

networks:
  jutjubic-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local

# ============================================================================
# KAKO DODATI NOVU REPLIKU (npr. replica-4):
# ============================================================================
# 1. Kopiraj jedan od backend servisa (npr. backend3)
# 2. Promeni:
#    - container_name: jutjubic-backend4
#    - REPLICA_ID: replica-4
#    - REPLICA_URLS: http://backend1:8080,http://backend2:8080,http://backend3:8080
#    - ports: "8084:8080"
# 3. Dodaj backend4 u nginx depends_on sekciju
# 4. Dodaj backend4 u nginx.conf upstream sekciju
# 5. A≈æuriraj REPLICA_URLS u SVIM ostalim replikama da ukljuƒçuju backend4
# 6. Pokreni: docker-compose up -d --build
# ============================================================================
